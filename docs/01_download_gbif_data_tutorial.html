<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>Downloading occurrences from GBIF</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/readable.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.0.13/css/fa-svg-with-js.css" rel="stylesheet" />
<script src="site_libs/font-awesome-5.0.13/js/fontawesome-all.min.js"></script>
<script src="site_libs/font-awesome-5.0.13/js/fa-v4-shims.min.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 66px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 71px;
  margin-top: -71px;
}

.section h2 {
  padding-top: 71px;
  margin-top: -71px;
}
.section h3 {
  padding-top: 71px;
  margin-top: -71px;
}
.section h4 {
  padding-top: 71px;
  margin-top: -71px;
}
.section h5 {
  padding-top: 71px;
  margin-top: -71px;
}
.section h6 {
  padding-top: 71px;
  margin-top: -71px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->






<div class="navbar navbar-inverse  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Biodiversity data - from Field to Yield</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-home"></span>
     
    Home
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Exercises
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="01_download_GBIF_data_exercise.html">01 - Downloading data from GBIF</a>
    </li>
    <li>
      <a href="02_data_cleaning_exercise.html">02 - Data cleaning</a>
    </li>
    <li>
      <a href="03_sampling_biases_exercise.html">03 - Quantifying sampling bias</a>
    </li>
    <li>
      <a href="04_species_richness_maps_exercise.html">04 - Richness maps</a>
    </li>
    <li>
      <a href="05_range_size_and_conservation_assessment_exercise.html">05 - Range size and conservation assessment</a>
    </li>
    <li>
      <a href="06_taxon_specific_bioregionalization_exercise.html">06 - Bioregionalization</a>
    </li>
    <li>
      <a href="07_biome_classification_exercise.html">07 - Biome classification</a>
    </li>
    <li>
      <a href="08_maps_and_phylogenetic_visualization_exercise.html">08 - Visualization</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="01_download_gbif_data_tutorial.html">01 - Downloading data from GBIF</a>
    </li>
    <li>
      <a href="02_data_cleaning_tutorial.html">02 - Data cleaning</a>
    </li>
    <li>
      <a href="03_sampling_biases_tutorial.html">03 - Quantifying sampling bias</a>
    </li>
    <li>
      <a href="04_species_richness_maps_tutorial.html">04 - Richness maps</a>
    </li>
    <li>
      <a href="05_range_size_and_conservation_assessment_tutorial.html">05 - Range size and conservation assessment</a>
    </li>
    <li>
      <a href="07_biome_classification_tutorial.html">07 - Biome classification</a>
    </li>
    <li>
      <a href="08_maps_and_phylogenetic_visualization_tutorial.html">08 - Visualization</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/azizka/Biodiversity_Data_from_Field_to_Yield/">GitHub</a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Downloading occurrences from GBIF</h1>

</div>


<div id="setup" class="section level2">
<h2>Setup</h2>
<p>In this exercise we will use the rgbif library for communication with GBIF and the tidyverse library for data management.</p>
</div>
<div id="tutorial" class="section level1">
<h1>Tutorial</h1>
<p>In the following tutorial, we will go through the questions one-by-one. The suggested answers are by no means the only correct ones.</p>
<div id="download-data-for-a-single-species-we-saw-in-the-filedand-save-them-in-a-data.frame" class="section level2">
<h2>1. Download data for a single species we saw in the filedand save them in a data.frame</h2>
<p>GBIF hosts a large number of records and downloading all records might take some time (also the download limit using <code>occ_search</code> is 250,000), so it is worth checking first how many records are available. We do this using the <code>return</code> argument of the <code>occ_search</code> function, which will only return meta-data on the record. Chose a species from your project taxon, for demonstration will download records for the Malvaceae family. We’ll first download data for a single, wide-spread species, <em>Ceiba pentandra</em>:</p>
<pre class="r"><code># Search occurrence records
dat &lt;- occ_search(scientificName = &quot;Wittmackia patentissima&quot;, return = &quot;data&quot;, 
    limit = 10000)</code></pre>
</div>
<div id="explore-the-downloaded-data" class="section level2">
<h2>2. Explore the downloaded data</h2>
<pre class="r"><code>nrow(dat)  # Check the number of records
## [1] 6
head(dat)  # Check the data
## # A tibble: 6 x 74
##   name     key decimalLatitude decimalLongitude issues datasetKey
##   &lt;chr&gt;  &lt;int&gt;           &lt;dbl&gt;            &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;     
## 1 Aech~ 1.66e9           -16.4            -40.1 cdrou~ 4300f8d5-~
## 2 Aech~ 1.82e9           -21.9            -41.8 cdrou~ 4300f8d5-~
## 3 Aech~ 1.42e9            NA               NA   &quot;&quot;     4300f8d5-~
## 4 Aech~ 1.09e9             0                0   cucdm~ ca7f81ae-~
## 5 Aech~ 1.09e9           -12.5            -39.1 gass8~ ca7f81ae-~
## 6 Aech~ 1.50e9            NA               NA   &quot;&quot;     c23c9745-~
## # ... with 68 more variables: publishingOrgKey &lt;chr&gt;, networkKeys &lt;chr&gt;,
## #   installationKey &lt;chr&gt;, publishingCountry &lt;chr&gt;, protocol &lt;chr&gt;,
## #   lastCrawled &lt;chr&gt;, lastParsed &lt;chr&gt;, crawlId &lt;int&gt;, extensions &lt;chr&gt;,
## #   basisOfRecord &lt;chr&gt;, taxonKey &lt;int&gt;, kingdomKey &lt;int&gt;,
## #   phylumKey &lt;int&gt;, classKey &lt;int&gt;, orderKey &lt;int&gt;, familyKey &lt;int&gt;,
## #   genusKey &lt;int&gt;, speciesKey &lt;int&gt;, scientificName &lt;chr&gt;, kingdom &lt;chr&gt;,
## #   phylum &lt;chr&gt;, order &lt;chr&gt;, family &lt;chr&gt;, genus &lt;chr&gt;, species &lt;chr&gt;,
## #   genericName &lt;chr&gt;, specificEpithet &lt;chr&gt;, taxonRank &lt;chr&gt;,
## #   elevation &lt;dbl&gt;, stateProvince &lt;chr&gt;, year &lt;int&gt;, month &lt;int&gt;,
## #   day &lt;int&gt;, eventDate &lt;chr&gt;, modified &lt;chr&gt;, lastInterpreted &lt;chr&gt;,
## #   license &lt;chr&gt;, identifiers &lt;chr&gt;, facts &lt;chr&gt;, relations &lt;chr&gt;,
## #   geodeticDatum &lt;chr&gt;, class &lt;chr&gt;, countryCode &lt;chr&gt;, country &lt;chr&gt;,
## #   rightsHolder &lt;chr&gt;, identifier &lt;chr&gt;, recordNumber &lt;chr&gt;,
## #   datasetName &lt;chr&gt;, municipality &lt;chr&gt;, locality &lt;chr&gt;,
## #   http...unknown.org.http_..rs.tdwg.org.dwc.terms.Identification &lt;chr&gt;,
## #   gbifID &lt;chr&gt;, collectionCode &lt;chr&gt;, occurrenceID &lt;chr&gt;, type &lt;chr&gt;,
## #   catalogNumber &lt;chr&gt;, recordedBy &lt;chr&gt;, otherCatalogNumbers &lt;chr&gt;,
## #   institutionCode &lt;chr&gt;,
## #   http...unknown.org.http_..rs.gbif.org.terms.1.0.Multimedia &lt;chr&gt;,
## #   fieldNotes &lt;chr&gt;, occurrenceRemarks &lt;chr&gt;, identifiedBy &lt;chr&gt;,
## #   dateIdentified &lt;chr&gt;, continent &lt;chr&gt;, language &lt;chr&gt;,
## #   ownerInstitutionCode &lt;chr&gt;, elevationAccuracy &lt;dbl&gt;
plot(dat$decimalLatitude ~ dat$decimalLongitude)  # Look at the georeferenced records</code></pre>
<p><img src="01_download_gbif_data_tutorial_files/figure-html/unnamed-chunk-1-1.png" width="1152" /></p>
<p>So luckily there are a good number of records available. An as the quick visualization shows, a lot of the have geographic coordinates. See exercise eight for more detailed plotting. In the next exercise we will see how to reduce the amount of information and quality check the data. But let’s first download more relevant data for the project.</p>
</div>
<div id="how-many-records-are-available-for-your-group-of-interest" class="section level2">
<h2>3. How many records are available for your group of interest?</h2>
<p>For your project, we are interested not only in one species, but a larger taxonomic group. You can search for higher rank taxa using GBIF’s taxonKey. The taxonKey is a unique identifier for each taxon; we can obtain it from the taxon name via the <code>name _suggest</code> function. Since higher taxa might have a lot of records and downloading might take a lot of time, we will first check how many records are available. Here we will look at the entire genus <em>Ceiba</em>.</p>
<pre class="r"><code># Use the name_suggest function to get the gbif taxon key
tax_key &lt;- name_suggest(q = &quot;Magnoliopsida&quot;, rank = &quot;Class&quot;)

# Sometimes groups have multiple taxon keys, in this case three, so we will
# check how many records are available for them
lapply(tax_key$key, &quot;occ_count&quot;)
## [[1]]
## [1] 156038781

# Here the firsrt one is relevant, check for your group!
tax_key &lt;- tax_key$key[1]</code></pre>
<pre class="r"><code>occ_count(tax_key, country = &quot;BR&quot;)
## [1] 5286001</code></pre>
<p>There are more than five million records available from Brazil. This is too much for this exercise and also <code>occ_Search</code> is limited to 200000 records. Hence we will further limit the geographic extent. To do this you can use the Well-known-text format (WKT) to specify an area. Here we use a very simple rectangle, feel free to experiment. The download may take some minutes.</p>
<!-- 4. Download all data for your group from Brazil, or if the group is very large from the north east of Brazil. -->
<!-- You can now download the records for Brazyil. SInce we want to work with coordinates, we will only download those records that do have coordinates. -->
<!-- ```{r} -->
<!-- dat  <- occ_search(taxonKey = tax_key, return = "data",  -->
<!--                    country = "BR", hasCoordinate = T, limit = 10000)  -->
<!-- ``` -->
<!-- That leaves us with 6 records. If you are satisfied for your group you can go to the next step and save the data to the working directory. The limit for record searching using rgbif is 250,000 records, if your group has more records you may limit the geographic area to the north east of Brazil. To do this you can use the Well-known-text format (WKT) to specify an area. Here we use a very simple rectangle, feel free to experiment -->
<pre class="r"><code>study_a &lt;- &quot;POLYGON((-35 -4.5, -38.5 -4.5, -38.5 -7, -35 -7, -35 -4.5))&quot;

dat_ne &lt;- occ_search(taxonKey = tax_key, return = &quot;data&quot;, hasCoordinate = T, 
    geometry = study_a, limit = 50000)</code></pre>
<p>If you have a .kml or.shp file for which you want to download records you can import this into R using the <code>readOGR</code> function of the <code>rgdal</code> library and convert it into WKT format using <code>writeWKT</code> from the <code>rgeos</code> package.</p>
<pre class="r"><code>library(rgdal)
library(rgeos)

amz &lt;- readOGR(&quot;inst/Amazonia.kml&quot;)
## OGR data source with driver: KML 
## Source: &quot;C:\Users\alexander.zizka\Dropbox (Antonelli Lab)\Arbeit\teaching\2018_master_class_biogeography_natal\Biodiversity_Data_from_Field_to_Yield\inst\Amazonia.kml&quot;, layer: &quot;Amazonia.kml&quot;
## with 1 features
## It has 2 fields
# or for shape files: amz &lt;- readOGR(&#39;inst&#39;, layer = &#39;Amazonia&#39;)
rgeos::writeWKT(amz)
## [1] &quot;POLYGON ((-76.9477346799999964 -7.0194389099999999, -78.3736387400000041 -4.3190712400000004, -78.0601710800000035 -3.8241353000000000, -76.3746185300000064 0.4326462100000000, -69.0168776000000008 4.2327008099999999, -65.4526716900000025 7.2141156600000000, -64.6744867799999952 7.1858208000000001, -61.1841633299999970 3.1339204100000000, -60.2787929699999978 4.9501953099999998, -61.0374820799999966 7.0152309300000004, -60.4970037000000005 8.3096869099999999, -57.2257968500000018 5.9098308700000004, -52.7581200400000014 4.7939465500000003, -51.1787115799999981 2.6445180100000001, -50.6167120900000000 0.1139895100000000, -47.7102911400000025 -1.9330252600000000, -48.5912996699999979 -4.9784842200000003, -50.1147632999999999 -7.0796891000000004, -51.5632218399999971 -10.5246219799999992, -52.0896780699999979 -12.0724751999999995, -54.6409156699999983 -13.1151562300000002, -59.8512946499999998 -13.4630840299999992, -62.4270212099999995 -14.7640268700000004, -64.8187772899999999 -16.1741614799999986, -68.0658832000000018 -14.0724783900000006, -70.0810616899999985 -13.2063917899999996, -72.6249160100000068 -12.1702739500000003, -74.6065895100000063 -11.3634134000000007, -75.6563795699999986 -9.2172689999999999, -76.9477346799999964 -7.0194389099999999))&quot;</code></pre>
<ol start="5" style="list-style-type: decimal">
<li>Save the downloaded data as .txt or .csv to the working directory. You can save the results as text file to the working directory. To identify your working directory use <code>getwd()</code>.</li>
</ol>
<pre class="r"><code>write_csv(dat_ne, path = &quot;inst/gbif_occurrences.csv&quot;)</code></pre>
<p>If you want to use records from GBIF for publication, please make sure you cite them properly, using a DOI, you can get a DOI by using <code>occ_download</code>.</p>
<!-- ## 3. Download Bombacoideae records on subfamily rank -->
<!-- Unfortunately, downloading by subfamily is not recommendable due to taxonomic issues and because not all records are classified accordingly. Using the species keys from `name_lookup(q = Bombacoideae)` does not yield any records.  We'll therefor use a list of species, to download the records. We'll first get the GBIF taxonKey for all species in the list using the `name _suggest` function. You can either define the list directly in R, or if you want search for many species, you load a list from a text file. As an example, you can use the 'bombacoids_specs_list.txt' file. We are only interested in the actual data (no the meta-data), therefore `return = 'data'` and only those records that have coordinates (`hasCoordinate = T`). -->
<!-- ```{r} -->
<!-- #You can either create the species list in R, or if it is long list, download it from -->
<!-- # splist <- c("Adansonia digitata", "Ceiba pentandra") #for few speceis define in R like this -->
<!-- splist <- read_delim("Example_data/bombacoids_specs_list.txt", delim = "\t")%>% -->
<!-- unlist(use.names = F) -->
<!-- #get taxon keys -->
<!-- keys <- lapply(as.list(splist), function(x) name_suggest(x, rank = "species"))%>% -->
<!--   bind_rows()%>% -->
<!--   filter(canonicalName %in% splist)%>% -->
<!--   dplyr::select(key)%>% -->
<!--   unlist(use.names = F) -->
<!-- #obtain records -->
<!-- bomb.occ <- occ_search(taxonKey = keys, limit=50000, return = 'data', hasCoordinate = T) # remember to change the limit -->
<!-- ``` -->
<!-- 4. Save the downloaded data to the working directory. -->
<!-- The code above gives a list of the same length as the number of keys supplied (three in this case, as _Ceiba pentandra_ has two keys) consisting of data.frames with the occurrence records and large number of additional columns. WE will get rid of unnecessary information in the next exercise. For now we only want to get the data in a single data.frame and write it to the working directory -->
<!-- ```{r} -->
<!-- #sort out species without records -->
<!-- bomb.out <- bomb.occ[sapply(bomb.occ, "length", USE.NAMES = F) != 1]%>% -->
<!--   bind_rows() -->
<!-- write_csv(x = bomb.out, path = "bombacoideae_occurrences_gbif.csv") -->
<!-- ``` -->
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
